# История изменений проекта Agent Core NG

## [Unreleased] – 2026-02-20

### Добавлено
- **Динамические URL через переменные окружения:** все сервисные URL теперь настраиваются через env vars (`TOOLS_SERVICE_URL`, `BROWSER_SERVICE_URL`, `MEMORY_SERVICE_URL`, `AGENT_SERVICE_URL`, `GATEWAY_URL`, `OLLAMA_URL`, `OLLAMA_HOST`, `LM_STUDIO_URL`, `VITE_API_URL`). Хардкод полностью убран.
- **Подробное логирование для Админа:** каждый обработчик и executor в tools-service логирует входные параметры, результаты и ошибки с префиксами `[TOOLS]`, `[FILES]`, `[SYSTEM]` для удобной фильтрации. Админ-агент может читать и понимать выполнение инструментов.
- **Динамический резолв путей:** `list()`, `read()`, `write()` автоматически разрешают `~`, пустые пути и `~/subdir` через `os.UserHomeDir()`. Поле `home_dir` добавлено в `sysinfo()`.
- **LM Studio провайдер:** поддержка LM Studio (OpenAI-совместимый API на `localhost:1234/v1`)
- **Routeway провайдер:** поддержка Routeway API
- **Reasoning-модели:** stripThinkingTags для `[THINK]/[/THINK]` и `<think></think>`, retry логика для 503/504/429
- **Compound Skills:** составные навыки с поддержкой нескольких шагов
- **Tool call chaining:** цикл до 5 раундов вызовов инструментов (write→read, sysinfo→execute)
- **browser-service:** MCP-микросервис браузерного взаимодействия (headless Chrome, xdotool, wmctrl, DuckDuckGo, маскировка, CAPTCHA)
- **Система навыков (Skills):** YAML-описания + загрузчик + 5 встроенных навыков
- **CI/CD:** GitHub Actions — 4 проверки (agent-service, tools-service, api-gateway, web-ui)

### Тестирование
- **ТЕСТ 0 (Базовый чат):** PASS — агент отвечает через Routeway/OpenRouter
- **ТЕСТ 1 (Tool calling Админа):** PASS 5/5 — list(), sysinfo(), execute(), read(), write() работают корректно

## [0.1.0] – 2026-02-18

### Добавлено
- **Модель агента:** добавлено поле `Provider` (провайдер модели) со значением по умолчанию "ollama". Это закладывает основу для будущей поддержки онлайн-провайдеров (GigaChat, YandexGPT и др.).
- **Автоматический выбор модели:** при первом обращении к агенту система запрашивает список доступных моделей из локальной Ollama (через `ollama list` или API) и, если у агента не указана модель или она отсутствует, автоматически выбирает подходящую. Для моделей, поддерживающих инструменты, ищется модель из списка `SupportedToolModels` (llama3.1, mistral, mixtral), иначе берётся первая доступная.
- **Проверка наличия моделей:** если в Ollama нет ни одной модели, агент возвращает ошибку с инструкцией по установке (например, `ollama pull llama3.1:8b`).
- **Обработка JSON-вызовов инструментов:** в дополнение к стандартному полю `tool_calls` добавлен fallback-парсинг содержимого ответа модели как JSON-объекта с полями `name` и `arguments`. Это позволяет работать с моделями, которые возвращают вызов инструмента в виде текста.
- **Логирование:** добавлены отладочные логи для ответов Ollama и вызовов инструментов (можно отследить в `journalctl -u agent-agent.service`).
- **Конфигурация URL tools-service:** адрес tools-service теперь берётся из переменной окружения `TOOLS_SERVICE_URL` (по умолчанию `http://localhost:8080`), что позволяет гибко настраивать сетевые параметры.
- **Обновлён systemd-юнит:** в файл `/etc/systemd/system/agent-agent.service` добавлены переменные `TOOLS_SERVICE_URL` и `AGENT_SERVICE_PORT`.

### Изменено
- **Репозиторий агентов:** функция `CreateDefaultAgents` теперь создаёт агентов с пустым полем `LLMModel` (вместо жёстко прописанных имён). Модель выбирается динамически при первом использовании.
- **Функция `GetAgentByName`:** теперь перед возвратом агента вызывает `EnsureAgentModel`, которая обновляет модель при необходимости.
- **Типы в пакете `llm`:** поле `Arguments` в структуре `Function` изменено на `json.RawMessage` для корректного приёма как строки, так и объекта.
- **Список инструментов (`internal/tools/list.go`)**: имена инструментов приведены в соответствие с эндпоинтами tools-service (например, `execute`, `read`, `sysinfo`, `cputemp` и т.д.).

### Исправлено
- Ошибка `cannot unmarshal object into Go struct field ...` из-за несоответствия типа `Arguments`.
- Проблема с обновлением бинарника `agent-agent` (файл был занят) – теперь сервис останавливается перед копированием.

### Исправлено (CI)
- gofmt форматирование в agent-service и tools-service
- Удалена неиспользуемая переменная `updateChatLastMessage` в web-ui/App.tsx
- Все 4 CI джоба проходят: agent-service, tools-service, api-gateway, web-ui

### Технический долг (планы на будущее)
- Реализовать поддержку YandexGPT и GigaChat (клиенты написаны, нужно тестирование)
- Добавить хранение API-ключей в зашифрованном виде
- Реализовать ТЕСТ 2-6 (cron, файлы, оркестрация, память, обучение)
- Упаковать проект в deb-пакет для простой установки
