#!/usr/bin/env python3
import os
import subprocess
import sys
import threading
import time
try:
    import gi
    gi.require_version('Gtk', '3.0')
    gi.require_version('AppIndicator3', '0.1')
    from gi.repository import Gtk, AppIndicator3, GLib
    HAVE_TRAY = True
except ImportError:
    print("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ç—Ä–µ—è. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install gir1.2-appindicator3-0.1 python3-gi")
    HAVE_TRAY = False
    sys.exit(1)

class AgentTray:
    def __init__(self):
        # –ü—É—Ç—å –∫ –∏–∫–æ–Ω–∫–µ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –æ–Ω–∞ –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º)
        icon_path = os.path.join(os.path.dirname(__file__), "favicon.png")
        if not os.path.exists(icon_path):
            print(f"–ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø—É—Ç–∏: {icon_path}, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è")
            icon_name = "face-smile"
        else:
            icon_name = icon_path
            
        self.indicator = AppIndicator3.Indicator.new(
            "agent-core-ng",
            icon_name,
            AppIndicator3.IndicatorCategory.APPLICATION_STATUS
        )
        self.indicator.set_status(AppIndicator3.IndicatorStatus.ACTIVE)
        self.indicator.set_title("Agent Core NG")
        self.indicator.set_label("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...", "Status")
        self.indicator.set_menu(self.create_menu())
        self.update_status_thread()

    def create_menu(self):
        menu = Gtk.Menu()
        
        # –ü—É–Ω–∫—Ç "–û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
        item_open_ui = Gtk.MenuItem(label="–û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å")
        item_open_ui.connect("activate", self.open_web_interface)
        menu.append(item_open_ui)
        
        # –ü—É–Ω–∫—Ç "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
        item_restart = Gtk.MenuItem(label="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã")
        item_restart.connect("activate", self.restart_all)
        menu.append(item_restart)
        
        # –ü—É–Ω–∫—Ç "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤"
        item_status = Gtk.MenuItem(label="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤")
        item_status.connect("activate", self.show_status)
        menu.append(item_status)
        
        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        menu.append(Gtk.SeparatorMenuItem())
        
        # –ü—É–Ω–∫—Ç "–í—ã—Ö–æ–¥"
        item_quit = Gtk.MenuItem(label="–í—ã—Ö–æ–¥")
        item_quit.connect("activate", self.quit)
        menu.append(item_quit)
        
        menu.show_all()
        return menu

    def open_web_interface(self, _):
        """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ"""
        web_url = os.getenv('AGENT_WEB_URL', 'http://localhost:5178')
        try:
            # –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ xdg-open
            subprocess.run(["xdg-open", web_url], check=True)
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±
            try:
                subprocess.run(["firefox", web_url], check=True)
            except Exception:
                try:
                    subprocess.run(["google-chrome", web_url], check=True)
                except Exception:
                    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    dialog = Gtk.MessageDialog(
                        None,
                        Gtk.DialogFlags.MODAL,
                        Gtk.MessageType.INFO,
                        Gtk.ButtonsType.OK,
                        f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é –ø–æ –∞–¥—Ä–µ—Å—É: {web_url}"
                    )
                    dialog.run()
                    dialog.destroy()

    def show_status(self, _):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —á–µ—Ä–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"""
        services = ["agent-tools", "agent-agent", "agent-gateway"]
        status_lines = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
        for srv in services:
            status = "–∞–∫—Ç–∏–≤–µ–Ω" if self.check_service_status(srv) else "–Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
            status_lines.append(f"{srv}: {status} ({'üü¢' if self.check_service_status(srv) else 'üî¥'})")
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        web_accessible = self.check_web_interface()
        web_status = "–¥–æ—Å—Ç—É–ø–µ–Ω" if web_accessible else "–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        status_lines.append(f"–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {web_status} ({'üü¢' if web_accessible else 'üî¥'})")
            
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ ChromaDB
        chroma_result = subprocess.run(
            ["docker", "ps", "-q", "-f", "name=agent-chroma"],
            capture_output=True, text=True
        )
        chroma_status = "–∑–∞–ø—É—â–µ–Ω" if chroma_result.stdout.strip() else "–Ω–µ –∑–∞–ø—É—â–µ–Ω"
        status_lines.append(f"ChromaDB: {chroma_status}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
        try:
            file_count = len(subprocess.run(
                ["find", "agent-service/uploads", "-type", "f", "-name", "*.md"],
                capture_output=True, text=True
            ).stdout.strip().split('\n'))
            status_lines.append(f"–§–∞–π–ª–æ–≤ –≤ RAG: {file_count}")
        except:
            status_lines.append("–§–∞–π–ª–æ–≤ –≤ RAG: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ")
            
        # –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        dialog = Gtk.MessageDialog(
            None,
            Gtk.DialogFlags.MODAL,
            Gtk.MessageType.INFO,
            Gtk.ButtonsType.OK,
            "\n".join(status_lines)
        )
        dialog.set_title("–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã")
        dialog.run()
        dialog.destroy()

    def restart_all(self, _):
        """–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"""
        dialog = Gtk.MessageDialog(
            None,
            Gtk.DialogFlags.MODAL,
            Gtk.MessageType.WARNING,
            Gtk.ButtonsType.YES_NO,
            "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã?"
        )
        response = dialog.run()
        dialog.destroy()
        
        if response == Gtk.ResponseType.YES:
            try:
                # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
                subprocess.run(["sudo", "systemctl", "restart", "agent-tools"], check=True)
                subprocess.run(["sudo", "systemctl", "restart", "agent-agent"], check=True)
                subprocess.run(["sudo", "systemctl", "restart", "agent-gateway"], check=True)
                
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
                time.sleep(2)
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                dialog_success = Gtk.MessageDialog(
                    None,
                    Gtk.DialogFlags.MODAL,
                    Gtk.MessageType.INFO,
                    Gtk.ButtonsType.OK,
                    "–°–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã!"
                )
                dialog_success.run()
                dialog_success.destroy()
                
            except Exception as e:
                dialog_error = Gtk.MessageDialog(
                    None,
                    Gtk.DialogFlags.MODAL,
                    Gtk.MessageType.ERROR,
                    Gtk.ButtonsType.OK,
                    f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: {str(e)}"
                )
                dialog_error.run()
                dialog_error.destroy()

    def quit(self, _):
        """–ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        Gtk.main_quit()

    def check_service_status(self, service_name):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞"""
        try:
            result = subprocess.run(
                ["systemctl", "is-active", service_name],
                capture_output=True, text=True
            )
            return result.stdout.strip() == "active"
        except:
            return False

    def check_web_interface(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        web_url = os.getenv('AGENT_WEB_URL', 'http://localhost:5178')
        try:
            result = subprocess.run(
                ["curl", "-s", "-o", "/dev/null", "-w", "%{http_code}", web_url],
                capture_output=True, text=True, timeout=5
            )
            return result.stdout.strip() == "200"
        except:
            return False

    def update_status_thread(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ñ–æ–Ω–µ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏"""
        def update():
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
            services_ok = all(self.check_service_status(srv) for srv in ["agent-tools", "agent-agent", "agent-gateway"])
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            web_ok = self.check_web_interface()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫—É –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ —Ç—Ä–µ–µ
            icon_path = os.path.join(os.path.dirname(__file__), 
                                   "status-green.png" if (services_ok and web_ok) else "status-red.png")
            if os.path.exists(icon_path):
                self.indicator.set_icon_full(icon_path, "Status")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            GLib.timeout_add_seconds(10, update)
        
        # –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏
        GLib.timeout_add_seconds(1, update)

def main():
    if not HAVE_TRAY:
        print("–û—à–∏–±–∫–∞: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç—Ä–µ—è")
        return
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—Ä–µ–π-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    indicator = AgentTray()
    Gtk.main()

if __name__ == "__main__":
    main()
